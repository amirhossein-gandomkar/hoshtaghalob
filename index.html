<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ú†Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¬Ù…Ù†Ø§ÛŒ</title>
    
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        
        * { box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; margin: 0; padding: 0; }
        
        body { background-color: #121212; color: #e0e0e0; display: flex; height: 100vh; height: 100dvh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #1a1a1a; display: flex; flex-direction: column; border-left: 1px solid #333; transition: transform 0.3s; z-index: 100; flex-shrink: 0; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .new-chat-btn { width: 100%; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 10px; background: #2c2c2c; margin-bottom: 8px; border-radius: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item:hover { background: #3d3d3d; }
        .chat-item.active { border: 1px solid #4caf50; }

        /* Main Chat Area */
        .main-content { flex: 1; display: flex; flex-direction: column; width: calc(100% - 250px); height: 100%; position: relative; background-color: #121212; }
        
        .header { background: #1e1e1e; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .menu-btn { position: absolute; right: 15px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; display: none; }
        
        /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ú†Øª - Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø§Ø³Ú©Ø±ÙˆÙ„ */
        .chat-container { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 20px 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            scroll-behavior: smooth;
        }
        
        /* Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø±ÙˆÛŒ Ù‡Ù… Ø§ÙØªØ§Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ flex-shrink: 0 */
        .message { 
            flex-shrink: 0; 
            line-height: 1.8; 
            word-wrap: break-word; 
            overflow-wrap: break-word;
            font-size: 16px;
        }

        /* Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ø­Ø¨Ø§Ø¨ */
        .user-msg { 
            background: #2b5278; 
            align-self: flex-start; 
            padding: 12px 16px; 
            border-radius: 12px; 
            border-bottom-right-radius: 2px;
            max-width: 85%;
        }

        /* Ù¾ÛŒØ§Ù… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø¯Ø± Ùˆ Ø¢Ø²Ø§Ø¯ Ø¯Ø± ØµÙØ­Ù‡ */
        .ai-msg { 
            align-self: flex-start; 
            width: 100%; 
            padding: 0 5px; /* Ø­Ø°Ù Ú©Ø§Ø¯Ø± Ùˆ Ø¨Ú© Ú¯Ø±Ø§Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± */
            color: #ececec;
        }

        .message img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        
        /* ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØªÙ† Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† */
        pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; direction: ltr; margin: 15px 0; border: 1px solid #333; }
        code { background: #1e1e1e; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #f8c555; }
        p { margin-bottom: 10px; }
        ul, ol { margin-right: 20px; margin-bottom: 10px; }
        
        /* Input Area */
        .input-area { 
            background: #1e1e1e; 
            padding: 10px 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            border-top: 1px solid #333; 
            flex-shrink: 0; 
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            width: 100%;
        }
        
        .controls { display: flex; gap: 8px; align-items: center; width: 100%; }
        
        input[type="text"] { flex: 1; width: 100%; padding: 14px; border-radius: 12px; border: none; background: #2c2c2c; color: #fff; outline: none; font-size: 16px; transition: 0.2s; }
        input[type="text"]:focus { background: #333; }
        
        button { padding: 12px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .btn-send { background: #4caf50; flex-shrink: 0; min-width: 48px; }
        .btn-action { background: #444; flex-shrink: 0; min-width: 48px; }
        
        #selected-image-container { display: none; position: relative; width: 60px; height: 60px; }
        #selected-image { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid #555; }
        #remove-image { position: absolute; top: -5px; right: -5px; background: #d32f2f; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        
        .loading { text-align: right; color: #aaa; font-size: 0.9rem; padding: 5px 15px; display: none; flex-shrink: 0; }

        /* Camera Modal */
        #camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #video-preview { width: 100%; max-height: 70vh; object-fit: contain; }
        .camera-controls { padding: 20px; display: flex; gap: 15px; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .sidebar { position: fixed; right: 0; top: 0; height: 100%; transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .menu-btn { display: block; }
            .btn-action span, .btn-send span { display: none; }
            .controls { gap: 6px; }
            input[type="text"] { padding: 12px; }
            .user-msg { max-width: 90%; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">+ Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
            <button class="menu-btn" style="display: block; position: static; color: #fff;" onclick="toggleSidebar()">âœ–</button>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <!-- Main Chat -->
    <div class="main-content" onclick="closeSidebarIfMobile()">
        <div class="header">
            <button class="menu-btn" onclick="toggleSidebar(event)">â˜°</button>
            Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Gemini
        </div>
        
        <div class="chat-container" id="chat-box"></div>
        <div class="loading" id="loading">Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...</div>

        <!-- Ú©Ø§Ø¯Ø± ÙˆØ±ÙˆØ¯ Ù¾ÛŒØ§Ù… -->
        <div class="input-area">
            <div id="selected-image-container">
                <img id="selected-image" src="" alt="preview">
                <div id="remove-image" onclick="clearImage()">X</div>
            </div>

            <div class="controls">
                <button class="btn-action" onclick="document.getElementById('file-input').click()" title="Ú¯Ø§Ù„Ø±ÛŒ">ğŸ“ <span>Ú¯Ø§Ù„Ø±ÛŒ</span></button>
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                
                <button class="btn-action" onclick="openCamera()" title="Ø¯ÙˆØ±Ø¨ÛŒÙ†">ğŸ“· <span>Ø¯ÙˆØ±Ø¨ÛŒÙ†</span></button>
                
                <input type="text" id="user-input" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯..." onkeypress="if(event.key === 'Enter') sendMessage()">
                
                <button class="btn-send" onclick="sendMessage()" title="Ø§Ø±Ø³Ø§Ù„">ğŸš€ <span>Ø§Ø±Ø³Ø§Ù„</span></button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal">
        <video id="video-preview" autoplay playsinline></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div class="camera-controls">
            <button class="btn-send" onclick="takePhoto()">ğŸ“¸ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±</button>
            <button class="btn-action" style="background: #d32f2f;" onclick="closeCamera()">Ù„ØºÙˆ</button>
        </div>
    </div>

    <script>
        let currentImageBase64 = null;
        let currentMimeType = null;
        let videoStream = null;
        
        let chats = JSON.parse(localStorage.getItem('gemini_chats')) || [];
        let currentChatId = null;

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sidebar = document.getElementById('sidebar');

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Marked.js Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø¨Ù†Ø¯ÛŒ
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        initChats();

        function initChats() {
            if (chats.length === 0) startNewChat();
            else loadChat(chats[0].id);
            renderChatList();
        }

        function toggleSidebar(e) {
            if(e) e.stopPropagation();
            sidebar.classList.toggle('open');
        }

        function closeSidebarIfMobile() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
        }

        function startNewChat() {
            const newChat = {
                id: Date.now(),
                title: 'Ú†Øª ' + new Date().toLocaleTimeString('fa-IR'),
                messages: [],   
                history: []     
            };
            chats.unshift(newChat);
            saveChats();
            loadChat(newChat.id);
            renderChatList();
            if(window.innerWidth <= 768) sidebar.classList.remove('open');
        }

        function saveChats() {
            try {
                localStorage.setItem('gemini_chats', JSON.stringify(chats));
            } catch (e) {
                console.warn("Ø­Ø§ÙØ¸Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.");
            }
        }

        function getActiveChat() {
            return chats.find(c => c.id === currentChatId);
        }

        function renderChatList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                div.innerText = chat.title;
                div.onclick = () => { loadChat(chat.id); if(window.innerWidth <= 768) sidebar.classList.remove('open'); };
                list.appendChild(div);
            });
        }

        function loadChat(id) {
            currentChatId = id;
            chatBox.innerHTML = '';
            const chat = getActiveChat();
            if (chat.messages.length === 0) {
                appendMessageToUI('ai', 'Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù…. Ú†Ù‡ Ú©Ù…Ú©ÛŒ Ø§Ø² Ù…Ù† Ø³Ø§Ø®ØªÙ‡ Ø§Ø³ØªØŸ', false);
            } else {
                chat.messages.forEach(msg => appendMessageToUI(msg.sender, msg.text, false, msg.imgSrc));
            }
            renderChatList();
        }

        function scrollToBottom() {
            setTimeout(() => { 
                chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' }); 
            }, 100);
        }

        function appendMessageToUI(sender, text, save = true, imgSrc = null) {
            const div = document.createElement('div');
            div.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
            
            if (text) {
                const textDiv = document.createElement('div');
                textDiv.dir = sender === 'user' ? 'rtl' : 'auto';
                
                // Ø¯Ø± Ù¾ÛŒØ§Ù… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                if(sender === 'ai') {
                    textDiv.innerHTML = marked.parse(text);
                } else {
                    textDiv.innerText = text; // Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± Ø³Ø§Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
                }
                
                div.appendChild(textDiv);
            }
            if (imgSrc) {
                const img = document.createElement('img');
                img.src = imgSrc;
                img.onload = scrollToBottom; // ÙˆÙ‚ØªÛŒ Ø¹Ú©Ø³ Ù„ÙˆØ¯ Ø´Ø¯ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù†
                div.appendChild(img);
            }
            
            chatBox.appendChild(div);
            scrollToBottom();

            // Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø¨Ù‡ ØµÙØ­Ù‡
            if (window.MathJax && sender === 'ai') {
                MathJax.typesetPromise([div]).catch(err => console.log('MathJax error:', err)).then(scrollToBottom);
            }

            if (save) {
                const chat = getActiveChat();
                chat.messages.push({ sender, text, imgSrc: imgSrc ? imgSrc : null });
                if (chat.title.startsWith('Ú†Øª') && sender === 'user' && text) {
                    chat.title = text.substring(0, 20) + '...';
                    renderChatList();
                }
                saveChats();
            }
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentImageBase64) return;

            const imgSrc = currentImageBase64 ? document.getElementById('selected-image').src : null;
            appendMessageToUI('user', text, true, imgSrc);
            
            const requestBody = {
                text: text,
                imageBase64: currentImageBase64,
                mimeType: currentMimeType,
                history: getActiveChat().history 
            };

            const userParts = [];
            if(text) userParts.push({text});

            getActiveChat().history.push({ role: "user", parts: userParts });

            userInput.value = '';
            clearImage();
            userInput.blur();
            
            document.getElementById('loading').style.display = 'block';
            scrollToBottom();

            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (response.ok) {
                    appendMessageToUI('ai', data.reply, true);
                    getActiveChat().history.push({ role: "model", parts: [{ text: data.reply }] });
                    saveChats();
                } else {
                    appendMessageToUI('ai', 'Ø®Ø·Ø§: ' + (data.error || 'Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.'), false);
                }
            } catch (error) {
                appendMessageToUI('ai', 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ' + error.message, false);
            } finally {
                document.getElementById('loading').style.display = 'none';
                scrollToBottom();
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => setImageForSending(e.target.result, file.type);
                reader.readAsDataURL(file);
            }
        }

        async function openCamera() {
            document.getElementById('camera-modal').style.display = 'flex';
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video-preview').srcObject = videoStream;
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†.');
                closeCamera();
            }
        }

        function closeCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function takePhoto() {
            const video = document.getElementById('video-preview');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            setImageForSending(canvas.toDataURL('image/jpeg', 0.8), 'image/jpeg');
            closeCamera();
        }

        function setImageForSending(dataUrl, mimeType) {
            document.getElementById('selected-image').src = dataUrl;
            document.getElementById('selected-image-container').style.display = 'block';
            currentImageBase64 = dataUrl.split(',')[1];
            currentMimeType = mimeType;
        }

        function clearImage() {
            currentImageBase64 = null;
            currentMimeType = null;
            document.getElementById('selected-image-container').style.display = 'none';
            document.getElementById('file-input').value = '';
        }
    </script>
</body>
</html>
