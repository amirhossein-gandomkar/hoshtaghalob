<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ú†Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¬Ù…Ù†Ø§ÛŒ</title>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ú©Ø¯Ù‡Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ÛŒ Ùˆ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        
        * { box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; margin: 0; padding: 0; }
        body { background-color: #121212; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar (History) */
        .sidebar { width: 250px; background: #1a1a1a; display: flex; flex-direction: column; border-left: 1px solid #333; transition: transform 0.3s; z-index: 100; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .new-chat-btn { width: 100%; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 10px; background: #2c2c2c; margin-bottom: 8px; border-radius: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item:hover { background: #3d3d3d; }
        .chat-item.active { border: 1px solid #4caf50; }

        /* Main Chat Area */
        .main-content { flex: 1; display: flex; flex-direction: column; width: calc(100% - 250px); }
        .header { background: #1e1e1e; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; position: relative; }
        .menu-btn { position: absolute; right: 15px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; display: none; }
        
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 90%; padding: 12px 16px; border-radius: 12px; line-height: 1.6; word-wrap: break-word; overflow-x: auto; }
        .user-msg { background: #2b5278; align-self: flex-start; border-bottom-right-radius: 2px; }
        .ai-msg { background: #1e1e1e; align-self: flex-end; border-bottom-left-radius: 2px; border: 1px solid #333; width: 100%; max-width: 100%; }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        
        /* Formats */
        pre { background: #000; padding: 10px; border-radius: 8px; overflow-x: auto; direction: ltr; margin: 10px 0; }
        code { background: #000; padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        
        /* Input Area */
        .input-area { background: #1e1e1e; padding: 10px; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #333; }
        .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        input[type="text"] { flex: 1; min-width: 150px; padding: 12px; border-radius: 8px; border: none; background: #2c2c2c; color: #fff; outline: none; }
        button { padding: 10px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
        .btn-send { background: #4caf50; flex-shrink: 0; }
        .btn-action { background: #555; flex-shrink: 0; }
        
        #selected-image-container { display: none; position: relative; width: 80px; height: 80px; }
        #selected-image { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        #remove-image { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .loading { text-align: right; color: #888; font-size: 0.9rem; padding: 0 15px; display: none; }

        /* Camera Modal */
        #camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #video-preview { width: 100%; max-height: 70vh; object-fit: contain; }
        .camera-controls { padding: 20px; display: flex; gap: 15px; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .sidebar { position: fixed; right: 0; top: 0; height: 100%; transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { width: 100%; }
            .menu-btn { display: block; }
            .controls { flex-wrap: nowrap; }
            .btn-action span { display: none; } /* Hide text on small screens, show emoji */
        }
    </style>
</head>
<body>

    <!-- Sidebar History -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">+ Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
            <button class="menu-btn" style="display: block; position: static; color: #fff;" onclick="toggleSidebar()">âœ–</button>
        </div>
        <div class="chat-list" id="chat-list">
            <!-- Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒÚ¯ÛŒØ±Ù‡ -->
        </div>
    </div>

    <!-- Main Chat -->
    <div class="main-content" onclick="closeSidebarIfMobile()">
        <div class="header">
            <button class="menu-btn" onclick="toggleSidebar(event)">â˜°</button>
            Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Gemini
        </div>
        
        <div class="chat-container" id="chat-box"></div>
        <div class="loading" id="loading">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>

        <div class="input-area">
            <div id="selected-image-container">
                <img id="selected-image" src="" alt="preview">
                <div id="remove-image" onclick="clearImage()">X</div>
            </div>

            <div class="controls">
                <button class="btn-action" onclick="document.getElementById('file-input').click()">ğŸ“ <span>Ú¯Ø§Ù„Ø±ÛŒ</span></button>
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                
                <button class="btn-action" onclick="openCamera()">ğŸ“· <span>Ø¯ÙˆØ±Ø¨ÛŒÙ†</span></button>
                
                <input type="text" id="user-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="btn-send" onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„ ğŸš€</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal">
        <video id="video-preview" autoplay playsinline></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div class="camera-controls">
            <button class="btn-send" onclick="takePhoto()">ğŸ“¸ Ú¯Ø±ÙØªÙ† Ø¹Ú©Ø³</button>
            <button class="btn-action" style="background: #d32f2f;" onclick="closeCamera()">Ù„ØºÙˆ</button>
        </div>
    </div>

    <script>
        // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ ---
        let currentImageBase64 = null;
        let currentMimeType = null;
        let videoStream = null;
        
        // --- Ø³ÛŒØ³ØªÙ… Ø­Ø§ÙØ¸Ù‡ Ú†Øª ---
        let chats = JSON.parse(localStorage.getItem('gemini_chats')) || [];
        let currentChatId = null;

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sidebar = document.getElementById('sidebar');

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        initChats();

        function initChats() {
            if (chats.length === 0) startNewChat();
            else loadChat(chats[0].id);
            renderChatList();
        }

        function toggleSidebar(e) {
            if(e) e.stopPropagation();
            sidebar.classList.toggle('open');
        }

        function closeSidebarIfMobile() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
        }

        function startNewChat() {
            const newChat = {
                id: Date.now(),
                title: 'Ú†Øª ' + new Date().toLocaleTimeString('fa-IR'),
                messages: [],   // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± UI
                history: []     // Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ API Ú¯ÙˆÚ¯Ù„
            };
            chats.unshift(newChat);
            saveChats();
            loadChat(newChat.id);
            renderChatList();
            if(window.innerWidth <= 768) toggleSidebar();
        }

        function saveChats() {
            try {
                localStorage.setItem('gemini_chats', JSON.stringify(chats));
            } catch (e) {
                console.warn("Ø­Ø§ÙØ¸Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´ÙˆÙ†Ø¯.");
            }
        }

        function getActiveChat() {
            return chats.find(c => c.id === currentChatId);
        }

        function renderChatList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                div.innerText = chat.title;
                div.onclick = () => { loadChat(chat.id); if(window.innerWidth <= 768) toggleSidebar(); };
                list.appendChild(div);
            });
        }

        function loadChat(id) {
            currentChatId = id;
            chatBox.innerHTML = '';
            const chat = getActiveChat();
            if (chat.messages.length === 0) {
                appendMessageToUI('ai', 'Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù…. Ú†Ù‡ Ú©Ù…Ú©ÛŒ Ø§Ø² Ù…Ù† Ø³Ø§Ø®ØªÙ‡ Ø§Ø³ØªØŸ', false);
            } else {
                chat.messages.forEach(msg => appendMessageToUI(msg.sender, msg.text, false, msg.imgSrc));
            }
            renderChatList();
        }

        // --- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ø±Ù†Ø¯Ø± ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ ---
        function appendMessageToUI(sender, text, save = true, imgSrc = null) {
            const div = document.createElement('div');
            div.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
            
            if (text) {
                const textDiv = document.createElement('div');
                textDiv.dir = sender === 'user' ? 'rtl' : 'auto';
                // ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ†
                textDiv.innerHTML = marked.parse(text);
                div.appendChild(textDiv);
            }
            if (imgSrc) {
                const img = document.createElement('img');
                img.src = imgSrc;
                div.appendChild(img);
            }
            
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù…ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ø¨Ø§ MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([div]).catch(err => console.log('MathJax error:', err));
            }

            if (save) {
                const chat = getActiveChat();
                chat.messages.push({ sender, text, imgSrc: imgSrc ? imgSrc : null });
                if (chat.title.startsWith('Ú†Øª') && sender === 'user' && text) {
                    chat.title = text.substring(0, 20) + '...';
                    renderChatList();
                }
                saveChats();
            }
        }

        // --- Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø³Ø±ÙˆØ± ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentImageBase64) return;

            const imgSrc = document.getElementById('selected-image').src;
            appendMessageToUI('user', text, true, currentImageBase64 ? imgSrc : null);
            
            const requestBody = {
                text: text,
                imageBase64: currentImageBase64,
                mimeType: currentMimeType,
                history: getActiveChat().history // Ø§Ø±Ø³Ø§Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            };

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ API
            const userParts = [];
            if(text) userParts.push({text});
            // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø³Ù†Ú¯ÛŒÙ† Ø´Ø¯Ù†ØŒ Ø¹Ú©Ø³ Ø±Ùˆ ØªÙˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ API Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ ÙÙ‚Ø· ØªÙˆ Ù‡Ù…ÙˆÙ† Ù„Ø­Ø¸Ù‡ Ù…ÛŒÙØ±Ø³ØªÛŒÙ…

            getActiveChat().history.push({ role: "user", parts: userParts });

            userInput.value = '';
            clearImage();
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                if (response.ok) {
                    appendMessageToUI('ai', data.reply, true);
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¬ÙˆØ§Ø¨ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ API
                    getActiveChat().history.push({ role: "model", parts: [{ text: data.reply }] });
                    saveChats();
                } else {
                    appendMessageToUI('ai', 'Ø®Ø·Ø§: ' + (data.error || 'Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.'), false);
                }
            } catch (error) {
                appendMessageToUI('ai', 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ' + error.message, false);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ú¯Ø§Ù„Ø±ÛŒ ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => setImageForSending(e.target.result, file.type);
                reader.readAsDataURL(file);
            }
        }

        async function openCamera() {
            document.getElementById('camera-modal').style.display = 'flex';
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video-preview').srcObject = videoStream;
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†.');
                closeCamera();
            }
        }

        function closeCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function takePhoto() {
            const video = document.getElementById('video-preview');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            setImageForSending(canvas.toDataURL('image/jpeg', 0.8), 'image/jpeg');
            closeCamera();
        }

        function setImageForSending(dataUrl, mimeType) {
            document.getElementById('selected-image').src = dataUrl;
            document.getElementById('selected-image-container').style.display = 'block';
            currentImageBase64 = dataUrl.split(',')[1];
            currentMimeType = mimeType;
        }

        function clearImage() {
            currentImageBase64 = null;
            currentMimeType = null;
            document.getElementById('selected-image-container').style.display = 'none';
            document.getElementById('file-input').value = '';
        }
    </script>
</body>
</html>
